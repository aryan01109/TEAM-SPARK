const { http } = require('../../lib/helpers/http')
const buildApiError = require('../../lib/helpers/buildApiError')

class PostSet {
  constructor (hostname, token, uri, value) {
    this.hostname = hostname || 'https://ops.dotenvx.com'
    this.token = token
    this.uri = uri
    this.value = value
  }

  async run () {
    const token = this.token
    const uri = this.uri
    const value = this.value
    const url = `${this.hostname}/api/set`

    const resp = await http(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        uri,
        value
      })
    })

    if (resp.statusCode >= 400) {
      const json = await resp.body.json()
      throw buildApiError(resp.statusCode, json)
    }

    const text = await resp.body.text()
    return text
  }
}

module.exports = PostSet
