const si = require('systeminformation')
const dotenvx = require('@dotenvx/dotenvx')

const Session = require('./../db/session')
const PostObserve = require('./api/postObserve')
const PostGet = require('./api/postGet')
const PostSet = require('./api/postSet')

const gitUrl = require('./helpers/gitUrl')
const gitBranch = require('./helpers/gitBranch')
const dotenvxProjectId = require('./helpers/dotenvxProjectId')

const observe = async function (encoded, options = {}) {
  const sesh = new Session() // TODO: handle scenario where constructor fails

  let hostname = process.env.DOTENVX_OPS_HOSTNAME || process.env.DOTENVX_RADAR_HOSTNAME || options.hostname
  if (!hostname) {
    hostname = sesh.hostname()
  }

  let token = process.env.DOTENVX_OPS_TOKEN || process.env.DOTENVX_RADAR_TOKEN || options.token
  if (!token) {
    token = sesh.token()
  }

  const _pwd = process.cwd()
  const _dotenvxProjectId = process.env.DOTENVX_PROJECT_ID || options.dotenvxProjectId || dotenvxProjectId(_pwd, false)

  const _gitUrl = gitUrl()
  const _gitBranch = gitBranch()

  const system = await si.system()
  const _systemUuid = system.uuid

  const osInfo = await si.osInfo()
  const _osPlatform = osInfo.platform
  const _osArch = osInfo.arch

  const json = await new PostObserve(hostname, token, encoded, _pwd, _gitUrl, _gitBranch, _systemUuid, _osPlatform, _osArch, _dotenvxProjectId).run()

  return json
}

const get = async function (uri, options = {}) {
  const sesh = new Session() // TODO: handle scenario where constructor fails

  let hostname = process.env.DOTENVX_OPS_HOSTNAME || process.env.DOTENVX_RADAR_HOSTNAME || options.hostname
  if (!hostname) {
    hostname = sesh.hostname()
  }

  let token = process.env.DOTENVX_OPS_TOKEN || process.env.DOTENVX_RADAR_TOKEN || options.token
  if (!token) {
    token = sesh.token()
  }

  const value = await new PostGet(hostname, token, uri).run()
  return value
}

const set = async function (uri, value, options = {}) {
  const sesh = new Session() // TODO: handle scenario where constructor fails

  let hostname = process.env.DOTENVX_OPS_HOSTNAME || process.env.DOTENVX_RADAR_HOSTNAME || options.hostname
  if (!hostname) {
    hostname = sesh.hostname()
  }

  let token = process.env.DOTENVX_OPS_TOKEN || process.env.DOTENVX_RADAR_TOKEN || options.token
  if (!token) {
    token = sesh.token()
  }

  return await new PostSet(hostname, token, uri, value).run()
}

const config = function (options = {}) {
  return dotenvx.config(options)
}

module.exports = {
  observe,
  get,
  set,
  // dotenv proxies
  config
}
