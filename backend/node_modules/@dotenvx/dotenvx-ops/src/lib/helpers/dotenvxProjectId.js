const fs = require('fs')
const path = require('path')
const dotenvx = require('@dotenvx/dotenvx')
const Errors = require('./errors')

function dotenvxProjectId (cwd = process.cwd(), raiseErrors = true) {
  // 1. Prefer environment variable
  if (process.env.DOTENVX_PROJECT_ID && process.env.DOTENVX_PROJECT_ID.trim()) {
    return process.env.DOTENVX_PROJECT_ID.trim()
  }

  // 2. Otherwise, parse .env.x contents
  const filepath = path.join(cwd, '.env.x')
  // file must exist
  if (!fs.existsSync(filepath)) {
    const filename = path.basename(filepath)
    if (raiseErrors) {
      throw new Errors({ filename, filepath }).envXFileMissing()
    } else {
      return null
    }
  }

  if (fs.existsSync(filepath)) {
    const src = fs.readFileSync(filepath, 'utf8')
    const parsed = dotenvx.parse(src)
    if (parsed.DOTENVX_PROJECT_ID && parsed.DOTENVX_PROJECT_ID.trim()) {
      return parsed.DOTENVX_PROJECT_ID.trim()
    }
  }

  // 3. Nothing found
  return null
}

module.exports = dotenvxProjectId
