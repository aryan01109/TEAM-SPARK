const { logger } = require('@dotenvx/dotenvx')
const { chromium } = require('playwright')

const VIEWPORT_WIDTH = 1200
const VIEWPORT_HEIGHT = 742
const VIEWPORT = { width: VIEWPORT_WIDTH, height: VIEWPORT_HEIGHT }

async function playwrightConnect (channel = 'chrome') {
  const browser = await ensurePlaywrightBrowser(channel)
  const context = await browser.newContext({ viewport: VIEWPORT })
  const page = await context.newPage()

  return { browser, context, page }
}

async function ensurePlaywrightBrowser (channel = 'chrome') {
  try {
    return await chromium.launch({ headless: false, channel })
  } catch (err) {
    if (String(err).includes('Executable doesn\'t exist')) {
      logger.info('Installing chromium...')
      const cp = require('child_process')
      cp.execSync('npx playwright install chromium', { stdio: 'inherit' })
      return await chromium.launch({ headless: false })
    }
  }
}

module.exports = playwrightConnect
