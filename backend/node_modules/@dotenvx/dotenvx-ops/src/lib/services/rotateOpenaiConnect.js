const PostRotateConnect = require('./../api/postRotateConnect')

const playwrightConnect = require('./../helpers/playwrightConnect')

const TIMEOUT = 500 // visibility timeout
const TIMEOUT_MEDIUM = 5000 // visibility timeout
const TIMEOUT_LONG = 10000 // visibility timeout
const SLUG = 'openai' // hardcoded

class RotateOpenaiConnect {
  constructor (hostname, token, org, username, password, email = null) {
    this.hostname = hostname
    this.org = org
    this.token = token
    this.username = username
    this.password = password

    // optional
    this.email = username
  }

  async run () {
    const hostname = this.hostname
    const token = this.token
    const org = this.org
    const username = this.username
    const password = this.password
    const email = this.email

    const { browser, context, page } = await playwrightConnect()

    const emailSelector = 'input[type="email"]'
    const passwordSelector = 'input[type="password"]'

    await page.goto('https://platform.openai.com/login', { waitUntil: 'domcontentloaded' })
    await page.waitForTimeout(TIMEOUT)
    await page.fill(emailSelector, username)
    await page.waitForTimeout(TIMEOUT_MEDIUM)
    await page.getByRole('button', { name: /continue|confirm|/i }).first().click()
    await page.waitForTimeout(TIMEOUT_LONG)
    await page.fill(passwordSelector, password) // await page.fill('input[autocomplete="current-password"]', password)
    await page.waitForTimeout(TIMEOUT)
    await page.press('input[type="password"]', 'Enter')
    await page.waitForNavigation({ timeout: 0 })
    await page.waitForSelector('a[href="/settings"]', { state: 'visible', timeout: 0 })

    const playwrightStorageStateStringified = JSON.stringify(await context.storageState())

    const { uid, url } = await new PostRotateConnect(hostname, token, org, SLUG, username, password, email, playwrightStorageStateStringified).run()

    await browser.close()

    return {
      uid,
      url
    }
  }
}

module.exports = RotateOpenaiConnect
