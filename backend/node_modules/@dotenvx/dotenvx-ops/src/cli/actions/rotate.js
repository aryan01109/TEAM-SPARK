const { logger } = require('@dotenvx/dotenvx')
const Session = require('./../../db/session')
const Rotate = require('./../../lib/services/rotate')
const { createSpinner } = require('./../../lib/helpers/createSpinner')

const spinner = createSpinner('rotating..')

async function rotate (uri) {
  const options = this.opts()
  logger.debug(`options: ${JSON.stringify(options)}`)

  try {
    spinner.start()

    const sesh = new Session()
    const hostname = options.hostname
    const token = options.token || sesh.token()

    const { url, rotUid } = await new Rotate(hostname, token, uri).run()

    spinner.stop()

    logger.success(`✔ rotated [${url}]`)
    logger.help(`⮕ next run [dotenvx-ops get dotenvx://${rotUid}]`)
  } catch (error) {
    spinner.stop()
    if (error.message) {
      logger.error(error.message)
    } else {
      logger.error(error)
    }
    if (error.help) {
      logger.help(error.help)
    }
    if (error.stack) {
      logger.debug(error.stack)
    }
    process.exit(1)
  }
}

module.exports = rotate
