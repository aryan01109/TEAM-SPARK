const fs = require('fs')
const crypto = require('crypto')

const { logger } = require('@dotenvx/dotenvx')

const { createSpinner } = require('./../../lib/helpers/createSpinner')
const pluralize = require('./../../lib/helpers/pluralize')

const Sync = require('./../../lib/services/sync')
const SyncConflict = require('./../../lib/services/syncConflict')

const spinner = createSpinner('syncing')

function sha256File (filepath) {
  const buf = fs.readFileSync(filepath)
  return crypto.createHash('sha256').update(buf).digest('hex')
}

async function sync () {
  // debug opts
  const options = this.opts()

  try {
    logger.debug(`options: ${JSON.stringify(options)}`)

    spinner.start()

    const {
      projectUsernameName,
      files
    } = await new Sync(options.hostname, options.force).run()
    logger.debug(`files: ${JSON.stringify(files)}`)

    // write output files
    for (const file of files) {
      const { filepath, src, sha } = file

      let needsWrite = true
      if (fs.existsSync(filepath)) {
        const localSha = sha256File(filepath)
        needsWrite = localSha !== sha
      }

      if (needsWrite) {
        logger.debug(`writing ${filepath}`)
        fs.writeFileSync(filepath, src, 'utf8')
      } else {
        logger.debug(`unchanged ${filepath} (skipped)`)
      }
    }

    spinner.stop()

    logger.success(`✔ synced [${projectUsernameName}]`)
  } catch (error) {
    spinner.stop()
    if (error.message) {
      logger.error(error.message)
    } else {
      logger.error(error)
    }
    if (error.help) {
      logger.help(error.help)
    }
    if (error.stack) {
      logger.debug(error.stack)
    }

    try {
      if (error.code === 'DOTENVX_SYNC_CONFLICT') {
        spinner.start()

        const synchronizationId = error.meta.synchronization_id
        const { conflictedFiles } = await new SyncConflict(options.hostname, synchronizationId).run()

        spinner.stop()

        // loop through any conflicted files
        for (const conflictedFile of conflictedFiles) {
          logger.info('')
          logger.info(`✖ conflict [${conflictedFile.filepath}]`)
          console.log(conflictedFile.diffAnsi)
        }

        logger.info(`Review and edit the ${pluralize('file', conflictedFiles.length)} as needed, then confirm your version with [dotenvx-ops sync --force]`)
      }
    } catch (error) {
      spinner.stop()
      if (error.message) {
        logger.error(error.message)
      } else {
        logger.error(error)
      }
      if (error.help) {
        logger.help(error.help)
      }
      if (error.stack) {
        logger.debug(error.stack)
      }
    }

    process.exit(1)
  }
}

module.exports = sync
