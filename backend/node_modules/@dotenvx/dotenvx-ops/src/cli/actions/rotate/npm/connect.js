const { logger } = require('@dotenvx/dotenvx')
const prompts = require('@inquirer/prompts')
const Session = require('./../../../../db/session')
const RotateNpmConnect = require('./../../../../lib/services/rotateNpmConnect')
const { createSpinner } = require('./../../../../lib/helpers/createSpinner')
const GetAccount = require('./../../../../lib/api/getAccount')

const spinner = createSpinner('waiting on browser completion')

async function connect () {
  const options = this.opts()
  logger.debug(`options: ${JSON.stringify(options)}`)

  try {
    const sesh = new Session()
    const hostname = options.hostname
    const token = options.token || sesh.token()
    let org = options.org
    let username = options.username
    let password = options.password
    const email = options.email

    // user must be logged in to use feature
    const accountJson = await new GetAccount(hostname, token).run()

    if (!org) {
      const choices = accountJson.organizations.map(o => ({
        name: o.provider_slug,
        value: o.provider_slug
      }))

      if (choices.length === 1) {
        org = choices[0].value // just use first choice
      } else {
        org = await prompts.select({
          message: 'Select dotenvx organization',
          choices
        })
      }
    }

    if (!username) {
      username = await prompts.input({ message: 'npm username:' })
    }

    if (!password) {
      password = await prompts.password({ message: 'npm password:' })
    }

    spinner.start()

    const { uid, url } = await new RotateNpmConnect(hostname, token, org, username, password, email).run()

    spinner.stop()

    logger.success(`✔ connected [${url}]`)
    logger.help(`⮕ next run [dotenvx-ops rotate dotenvx://${uid}]`)
  } catch (error) {
    spinner.stop()
    if (error.message) {
      logger.error(error.message)
    } else {
      logger.error(error)
    }
    if (error.help) {
      logger.help(error.help)
    }
    if (error.stack) {
      logger.debug(error.stack)
    }
    process.exit(1)
  }
}

module.exports = connect
