const { Command } = require('commander')

const rotate = new Command('rotate')

const Session = require('./../../db/session')
const sesh = new Session()

rotate
  .description('rotate secret')
  .allowUnknownOption()

rotate.addCommand(require('./rotate/github'))
rotate.addCommand(require('./rotate/npm'))
rotate.addCommand(require('./rotate/openai'))

// dotenvx-ops rotate (fallback positional argument handler)
const rotateAction = require('../actions/rotate')
rotate
  .argument('[URI]', 'URI') // brackets = optional
  .option('--hostname <url>', 'set hostname', sesh.hostname())
  .option('--token <token>', 'set token')
  .action(async function (uri, options, command) {
    if (!uri) {
      command.help()
      return
    }

    // Call external action with correct "this" binding
    await rotateAction.call(this, uri)
  })

module.exports = rotate
